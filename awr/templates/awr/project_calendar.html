{% extends "base.html" %}

{% block title %}
    {% if project_name %}
        {{ project_name }} - Ranking Calendar
    {% else %}
        Project Calendar
    {% endif %}
{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
<style>
    .calendar-date {
        height: 120px;
    }
    
    .calendar-date.has-data {
        background-color: #e3f2fd;
        cursor: pointer;
    }
    
    .calendar-date.has-data:hover {
        background-color: #bbdefb;
    }
    
    .calendar-date.today {
        border: 2px solid #1976d2;
    }
    
    .calendar-day {
        font-weight: bold;
    }
    
    .depth-indicator {
        font-size: 0.8rem;
        padding: 2px 6px;
        border-radius: 3px;
    }
    
    .depth-5 {
        background-color: #c8e6c9;
    }
    
    .depth-10 {
        background-color: #a5d6a7;
    }
    
    .date-loader {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 9999;
    }
    
    .month-navigation {
        font-size: 1.2rem;
    }
</style>
{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1>
            <i class="bi bi-calendar-event"></i>
            {% if project_name %}
                {{ project_name }} - Ranking Calendar
            {% else %}
                Project Calendar
            {% endif %}
        </h1>
        <div>
            <a href="{% url 'awr:project_detail' project_id %}" class="btn btn-outline-secondary me-2">
                <i class="bi bi-arrow-left"></i> Back to Project
            </a>
            <button type="button" class="btn btn-primary" onclick="location.reload();">
                <i class="bi bi-arrow-clockwise"></i> Refresh
            </button>
        </div>
    </div>
    
    <div class="row">
        <div class="col-12">
            {% if error %}
                <div class="alert alert-danger">
                    <h4><i class="bi bi-exclamation-triangle"></i> API Error:</h4>
                    <p>{{ error }}</p>
                </div>
            {% endif %}
            
            {% if success_message %}
                <div class="alert alert-success">
                    <i class="bi bi-check-circle"></i> {{ success_message }}
                </div>
            {% endif %}
            
            {% if dates %}
                <!-- Month and Year Navigation -->
                <div class="card mb-4">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center">
                            <button id="prevMonth" class="btn btn-outline-primary">
                                <i class="bi bi-chevron-left"></i> Previous Month
                            </button>
                            
                            <h3 id="currentMonthYear" class="mb-0">
                                <!-- Will be filled by JavaScript -->
                            </h3>
                            
                            <button id="nextMonth" class="btn btn-outline-primary">
                                Next Month <i class="bi bi-chevron-right"></i>
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Calendar View -->
                <div class="card">
                    <div class="card-header bg-primary text-white">
                        <h4 class="mb-0"><i class="bi bi-calendar"></i> Data Availability Calendar</h4>
                    </div>
                    <div class="card-body">
                        <div class="calendar-container">
                            <div class="row mb-2">
                                <div class="col text-center">Sun</div>
                                <div class="col text-center">Mon</div>
                                <div class="col text-center">Tue</div>
                                <div class="col text-center">Wed</div>
                                <div class="col text-center">Thu</div>
                                <div class="col text-center">Fri</div>
                                <div class="col text-center">Sat</div>
                            </div>
                            
                            <div id="calendarGrid">
                                <!-- Calendar will be generated here -->
                                <div class="d-flex justify-content-center py-5">
                                    <div class="spinner-border text-primary" role="status">
                                        <span class="visually-hidden">Loading...</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Calendar Legend -->
                <div class="card mt-3">
                    <div class="card-body">
                        <h5>Legend:</h5>
                        <div class="d-flex gap-3">
                            <div>
                                <span class="depth-indicator depth-5">Depth 5</span>
                                <small class="text-muted ms-2">5 pages of search results</small>
                            </div>
                            <div>
                                <span class="depth-indicator depth-10">Depth 10</span>
                                <small class="text-muted ms-2">10 pages of search results</small>
                            </div>
                            <div>
                                <span class="badge bg-light text-dark border">Today</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Hidden Data Storage for JavaScript -->
                <div id="rankingDates" class="d-none" data-dates="{{ dates|safe }}"></div>
            {% else %}
                <div class="card">
                    <div class="card-header bg-warning">
                        <h4 class="mb-0">No Data Available</h4>
                    </div>
                    <div class="card-body">
                        <p>No ranking data dates found for this project.</p>
                        <p>Possible reasons:</p>
                        <ul>
                            <li>This project has no ranking data yet</li>
                            <li>The data might be from imported sources which aren't available via the API</li>
                            <li>There might be an issue with the API connection</li>
                        </ul>
                    </div>
                </div>
            {% endif %}
            
            {% if raw_response %}
                <div class="card mt-4">
                    <div class="card-header bg-dark text-white">
                        <h5 class="mb-0">
                            <i class="bi bi-braces"></i> Raw API Response
                            <button class="btn btn-sm btn-outline-light float-end" type="button" data-bs-toggle="collapse" data-bs-target="#rawResponseCollapse">
                                Toggle View
                            </button>
                        </h5>
                    </div>
                    <div id="rawResponseCollapse" class="collapse">
                        <div class="card-body">
                            <pre class="bg-light p-3"><code>{{ raw_response|pprint }}</code></pre>
                        </div>
                    </div>
                </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Date Details Modal -->
<div class="modal fade" id="dateDetailsModal" tabindex="-1" aria-labelledby="dateDetailsModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="dateDetailsModalLabel">Ranking Data for <span id="modalDate"></span></h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="d-flex justify-content-between mb-3">
                    <div>
                        <strong>Date:</strong> <span id="modalFullDate"></span>
                    </div>
                    <div>
                        <span class="badge bg-primary" id="modalDepth"></span>
                    </div>
                </div>
                
                <div class="alert alert-info">
                    <i class="bi bi-info-circle"></i>
                    This date has ranking data available. You can view rankings for this specific date in the AWR dashboard.
                </div>
                
                <div class="d-grid">
                    <a id="viewInAwrLink" href="#" target="_blank" class="btn btn-primary">
                        <i class="bi bi-box-arrow-up-right"></i> View in AWR Dashboard
                    </a>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Parse all available dates
        const datesContainer = document.getElementById('rankingDates');
        let rankingDates = [];
        
        try {
            // Get raw dates from data attribute
            const rawDates = datesContainer.getAttribute('data-dates');
            if (rawDates) {
                rankingDates = JSON.parse(rawDates.replace(/'/g, '"'));
            }
        } catch (e) {
            console.error('Error parsing dates:', e);
        }
        
        // Create a lookup map of dates with data
        const dateMap = {};
        rankingDates.forEach(dateObj => {
            dateMap[dateObj.date] = dateObj.depth;
        });
        
        // Initialize the calendar with current month
        let currentDate = new Date();
        renderCalendar(currentDate);
        
        // Event listeners for month navigation
        document.getElementById('prevMonth').addEventListener('click', () => {
            currentDate.setMonth(currentDate.getMonth() - 1);
            renderCalendar(currentDate);
        });
        
        document.getElementById('nextMonth').addEventListener('click', () => {
            currentDate.setMonth(currentDate.getMonth() + 1);
            renderCalendar(currentDate);
        });
        
        // Function to render the calendar for a given month
        function renderCalendar(date) {
            const year = date.getFullYear();
            const month = date.getMonth();
            
            // Update header
            const monthNames = ["January", "February", "March", "April", "May", "June",
                "July", "August", "September", "October", "November", "December"];
            document.getElementById('currentMonthYear').textContent = `${monthNames[month]} ${year}`;
            
            // Get the first day of the month
            const firstDayOfMonth = new Date(year, month, 1);
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            
            // Get the day of the week the first day falls on (0 = Sunday, 6 = Saturday)
            const firstDayWeekday = firstDayOfMonth.getDay();
            
            // Create the calendar grid
            const calendarGrid = document.getElementById('calendarGrid');
            calendarGrid.innerHTML = '';
            
            let dayCounter = 1;
            const today = new Date();
            const isCurrentMonth = (today.getFullYear() === year && today.getMonth() === month);
            
            // Create weeks (rows)
            for (let week = 0; week < 6; week++) {
                // Stop if we've displayed all days in the month
                if (dayCounter > daysInMonth) break;
                
                const weekRow = document.createElement('div');
                weekRow.className = 'row mb-2';
                
                // Create days (columns)
                for (let weekday = 0; weekday < 7; weekday++) {
                    const dayCell = document.createElement('div');
                    dayCell.className = 'col calendar-date p-2 border';
                    
                    // Skip cells before the first day of the month
                    if (week === 0 && weekday < firstDayWeekday) {
                        weekRow.appendChild(dayCell);
                        continue;
                    }
                    
                    // Stop if we've gone past the end of the month
                    if (dayCounter > daysInMonth) {
                        weekRow.appendChild(dayCell);
                        continue;
                    }
                    
                    // Format the date string YYYY-MM-DD
                    const monthStr = (month + 1).toString().padStart(2, '0');
                    const dayStr = dayCounter.toString().padStart(2, '0');
                    const dateStr = `${year}-${monthStr}-${dayStr}`;
                    
                    // Check if this date has ranking data
                    const hasData = dateMap[dateStr];
                    
                    // Check if this is today
                    const isToday = (isCurrentMonth && today.getDate() === dayCounter);
                    
                    // Build the cell content
                    if (hasData) {
                        dayCell.classList.add('has-data');
                        dayCell.dataset.date = dateStr;
                        dayCell.dataset.depth = hasData;
                        
                        dayCell.innerHTML = `
                            <div class="d-flex justify-content-between">
                                <span class="calendar-day">${dayCounter}</span>
                                <span class="depth-indicator depth-${hasData}">Depth ${hasData}</span>
                            </div>
                            <div class="text-center mt-3">
                                <small class="text-muted">Click to view</small>
                            </div>
                        `;
                        
                        // Add event listener for the cell
                        dayCell.addEventListener('click', function() {
                            showDateDetails(this.dataset.date, this.dataset.depth);
                        });
                    } else {
                        dayCell.innerHTML = `<span class="calendar-day">${dayCounter}</span>`;
                    }
                    
                    if (isToday) {
                        dayCell.classList.add('today');
                    }
                    
                    weekRow.appendChild(dayCell);
                    dayCounter++;
                }
                
                calendarGrid.appendChild(weekRow);
            }
        }
        
        // Function to show date details in modal
        function showDateDetails(date, depth) {
            const modal = new bootstrap.Modal(document.getElementById('dateDetailsModal'));
            
            // Format the date for display
            const dateObj = new Date(date);
            const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            const formattedDate = dateObj.toLocaleDateString('en-US', options);
            
            // Update modal content
            document.getElementById('modalDate').textContent = date;
            document.getElementById('modalFullDate').textContent = formattedDate;
            document.getElementById('modalDepth').textContent = `Depth: ${depth}`;
            
            // Set link to AWR dashboard (you may need to update this URL)
            const awrBaseUrl = 'https://app.advancedwebranking.com/';
            const projectId = '{{ project_id }}';
            const projectName = '{{ project_name|urlencode }}';
            document.getElementById('viewInAwrLink').href = 
                `${awrBaseUrl}#project/${projectId}/rankings/overview?date=${date}`;
            
            modal.show();
        }
    });
</script>
{% endblock %}